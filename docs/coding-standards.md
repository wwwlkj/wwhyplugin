# WWPlugin é¡¹ç›®ä»£ç è§„èŒƒ

## ğŸ“ ä¸­æ–‡æ³¨é‡Šè§„èŒƒ

### 1. æ–‡ä»¶å¤´æ³¨é‡Š
æ¯ä¸ªGoæ–‡ä»¶éƒ½åº”è¯¥åŒ…å«è¯¦ç»†çš„åŒ…çº§åˆ«æ³¨é‡Šï¼š

```go
// Package wwplugin æä¾›æ’ä»¶ä¸»æœºå®ç°
// è´Ÿè´£æ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€é€šä¿¡åè°ƒå’Œç›‘æ§
package wwplugin

import (
    "context"      // ä¸Šä¸‹æ–‡æ§åˆ¶ï¼Œç”¨äºå–æ¶ˆå’Œè¶…æ—¶ç®¡ç†
    "encoding/json" // JSONç¼–è§£ç ï¼Œç”¨äºé…ç½®å’Œæ•°æ®äº¤æ¢
    // ... å…¶ä»–å¯¼å…¥
)
```

### 2. ç»“æ„ä½“æ³¨é‡Šè§„èŒƒ

#### ä¸»è¦ç»“æ„ä½“
```go
// PluginHost æ’ä»¶ä¸»æœºç»“æ„ä½“ - ç®¡ç†æ’ä»¶ç”Ÿå‘½å‘¨æœŸå’Œé€šä¿¡
// ä½œä¸ºæ’ä»¶ç³»ç»Ÿçš„ä¸­å¿ƒæ§åˆ¶å™¨ï¼Œè´Ÿè´£åè°ƒæ‰€æœ‰æ’ä»¶çš„è¿è¡Œ
type PluginHost struct {
    // === æ ¸å¿ƒç»„ä»¶ === //
    config        *HostConfig       // ä¸»æœºé…ç½® - åŒ…å«ç«¯å£ã€æ—¥å¿—ç­‰å‚æ•°
    registry      *PluginRegistry   // æ’ä»¶æ³¨å†Œè¡¨ - ç®¡ç†æ‰€æœ‰å·²åŠ è½½çš„æ’ä»¶
    
    // === æ§åˆ¶ç»„ä»¶ === //
    ctx          context.Context    // å…¨å±€ä¸Šä¸‹æ–‡ - ç”¨äºç»Ÿä¸€å–æ¶ˆæ“ä½œ
    cancel       context.CancelFunc // å–æ¶ˆå‡½æ•° - ç”¨äºåœæ­¢æ‰€æœ‰å­æ“ä½œ
}
```

#### é…ç½®ç»“æ„ä½“
```go
// HostConfig ä¸»ç¨‹åºé…ç½®ç»“æ„ä½“
// åŒ…å«ä¸»æœºè¿è¡Œæ‰€éœ€çš„æ‰€æœ‰é…ç½®å‚æ•°
type HostConfig struct {
    // === ç½‘ç»œé…ç½® === //
    Port      int   `json:"port"`       // gRPCæœåŠ¡ç«¯å£ï¼ˆ0è¡¨ç¤ºè‡ªåŠ¨åˆ†é…ï¼‰
    PortRange []int `json:"port_range"` // ç«¯å£èŒƒå›´ [start, end] - è‡ªåŠ¨åˆ†é…æ—¶çš„èŒƒå›´
    
    // === å¥åº·ç›‘æ§ === //
    HeartbeatInterval time.Duration `json:"heartbeat_interval"`  // å¿ƒè·³é—´éš” - æ£€æŸ¥æ’ä»¶å¥åº·çš„æ—¶é—´é—´éš”
    MaxHeartbeatMiss  int           `json:"max_heartbeat_miss"`  // æœ€å¤§å¿ƒè·³ä¸¢å¤±æ¬¡æ•° - è¶…è¿‡åè®¤ä¸ºæ’ä»¶å´©æºƒ
}
```

### 3. å‡½æ•°æ³¨é‡Šè§„èŒƒ

#### æ„é€ å‡½æ•°
```go
// NewPluginHost åˆ›å»ºæ–°çš„æ’ä»¶ä¸»æœºå®ä¾‹
// åˆå§‹åŒ–ä¸»æœºæ‰€éœ€çš„æ‰€æœ‰ç»„ä»¶ï¼šæ³¨å†Œè¡¨ã€æœåŠ¡ã€ä¸Šä¸‹æ–‡ç­‰
// å‚æ•°:
//   - config: ä¸»æœºé…ç½®ï¼Œå¦‚ä¸ºnilåˆ™ä½¿ç”¨é»˜è®¤é…ç½®
// è¿”å›:
//   - *PluginHost: åˆå§‹åŒ–å®Œæˆçš„ä¸»æœºå®ä¾‹
//   - error: åˆ›å»ºè¿‡ç¨‹ä¸­çš„é”™è¯¯
func NewPluginHost(config *HostConfig) (*PluginHost, error) {
    // å¦‚æœæ²¡æœ‰æä¾›é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
    if config == nil {
        config = DefaultHostConfig()
    }
    // ... å®ç°
}
```

#### æ ¸å¿ƒæ–¹æ³•
```go
// Start å¯åŠ¨æ’ä»¶ä¸»æœº
// è¿™å°†å¯åŠ¨gRPCæœåŠ¡å™¨å¹¶å¼€å§‹ç›‘å¬æ’ä»¶è¿æ¥
// è¿”å›:
//   - error: å¯åŠ¨è¿‡ç¨‹ä¸­çš„é”™è¯¯
func (ph *PluginHost) Start() error {
    log.Printf("ğŸš€ å¯åŠ¨æ’ä»¶ä¸»æœº...")
    
    // å¯åŠ¨gRPCæœåŠ¡å™¨
    if err := ph.startGrpcServer(); err != nil {
        return fmt.Errorf("å¯åŠ¨gRPCæœåŠ¡å™¨å¤±è´¥: %v", err)
    }
    // ... å…¶ä»–å¯åŠ¨æ­¥éª¤
}
```

### 4. å˜é‡å’Œå¸¸é‡æ³¨é‡Š

#### çŠ¶æ€å¸¸é‡
```go
// æ’ä»¶çŠ¶æ€å¸¸é‡å®šä¹‰
const (
    StatusStopped  PluginStatus = "stopped"  // æ’ä»¶å·²åœæ­¢ - åˆå§‹çŠ¶æ€æˆ–æ­£å¸¸åœæ­¢
    StatusStarting PluginStatus = "starting" // æ’ä»¶æ­£åœ¨å¯åŠ¨ä¸­ - è¿‡æ¸¡çŠ¶æ€
    StatusRunning  PluginStatus = "running"  // æ’ä»¶æ­£å¸¸è¿è¡Œä¸­ - å¯æ¥æ”¶è°ƒç”¨
    StatusCrashed  PluginStatus = "crashed"  // æ’ä»¶å´©æºƒ - å¯èƒ½éœ€è¦é‡å¯
)
```

#### ç‰ˆæœ¬ä¿¡æ¯
```go
// Version åº“ç‰ˆæœ¬å·
// éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒ (Semantic Versioning)
const Version = "1.0.0"
```

### 5. ç¤ºä¾‹ä»£ç æ³¨é‡Š

#### ä¸»æœºç¤ºä¾‹
```go
// main ä¸»å‡½æ•° - ç¨‹åºå…¥å£ç‚¹
// æ¼”ç¤ºå®Œæ•´çš„æ’ä»¶ä¸»æœºç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»ºã€å¯åŠ¨ã€åŠ è½½æ’ä»¶ã€æµ‹è¯•åŠŸèƒ½
func main() {
    // åˆ›å»ºæ’ä»¶ä¸»æœºé…ç½®
    // ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œå¯æ ¹æ®éœ€è¦ä¿®æ”¹å‚æ•°
    config := wwplugin.DefaultHostConfig()
    config.DebugMode = true // å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œè¾“å‡ºè¯¦ç»†æ—¥å¿—
    
    // åˆ›å»ºæ’ä»¶ä¸»æœºå®ä¾‹
    // ä¸»æœºè´Ÿè´£ç®¡ç†æ‰€æœ‰æ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸ
    host, err := wwplugin.NewPluginHost(config)
    if err != nil {
        log.Fatal(err) // åˆ›å»ºå¤±è´¥åˆ™é€€å‡ºç¨‹åº
    }
}
```

#### æ’ä»¶ç¤ºä¾‹
```go
// main ä¸»å‡½æ•° - æ’ä»¶ç¨‹åºå…¥å£ç‚¹
// å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼Œæ”¯æŒ--infoæŸ¥è¯¢æ¨¡å¼å’Œæ­£å¸¸è¿è¡Œæ¨¡å¼
func main() {
    // æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°ï¼Œæ”¯æŒä¿¡æ¯æŸ¥è¯¢æ¨¡å¼
    // --info å‚æ•°ç”¨äºè·å–æ’ä»¶å…ƒæ•°æ®ï¼Œè€Œä¸å¯åŠ¨æœåŠ¡
    if len(os.Args) > 1 && os.Args[1] == "--info" {
        // ä¿¡æ¯æŸ¥è¯¢æ¨¡å¼ï¼šä¸å¯åŠ¨æœåŠ¡ï¼Œåªè¾“å‡ºæ’ä»¶ä¿¡æ¯
        // ä¸»æœºå¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½åœ¨ä¸åŠ è½½æ’ä»¶çš„æƒ…å†µä¸‹è·å–æ’ä»¶ä¿¡æ¯
        plugin := createSamplePlugin() // åˆ›å»ºæ’ä»¶å®ä¾‹ä½†ä¸å¯åŠ¨æœåŠ¡
        if err := plugin.StartWithInfo(); err != nil {
            os.Exit(1) // ä¿¡æ¯æŸ¥è¯¢å¤±è´¥åˆ™é€€å‡º
        }
        os.Exit(0) // æ­£å¸¸é€€å‡ºä¿¡æ¯æŸ¥è¯¢æ¨¡å¼
    }
}
```

### 6. ç‰¹æ®Šæ³¨é‡Šæ ‡è®°

#### åˆ†ç»„æ³¨é‡Š
```go
type PluginInfo struct {
    // === åŸºæœ¬ä¿¡æ¯ === //
    ID             string   // æ’ä»¶å”¯ä¸€æ ‡è¯†ç¬¦ - ç”¨äºåŒºåˆ†ä¸åŒæ’ä»¶å®ä¾‹
    Name           string   // æ’ä»¶åç§° - ç”¨æˆ·å‹å¥½çš„æ˜¾ç¤ºåç§°
    
    // === è¿è¡Œæ—¶ä¿¡æ¯ === //
    Process       *os.Process  // æ’ä»¶è¿›ç¨‹å¯¹è±¡ - ç”¨äºè¿›ç¨‹æ§åˆ¶
    Connection    *grpc.ClientConn // gRPCè¿æ¥å¯¹è±¡ - ç®¡ç†ç½‘ç»œè¿æ¥
    
    // === é…ç½®å‚æ•° === //
    AutoRestart  bool // æ˜¯å¦åœ¨æ’ä»¶å´©æºƒæ—¶è‡ªåŠ¨é‡å¯ - å®¹é”™é…ç½®
    MaxRestarts  int  // æœ€å¤§é‡å¯æ¬¡æ•° - é˜²æ­¢æ— é™é‡å¯
}
```

#### é‡è¦æç¤ºæ³¨é‡Š
```go
// æ³¨æ„ï¼šè¿™äº›æ˜¯ç±»å‹åˆ«åï¼ŒæŒ‡å‘å½“å‰åŒ…ä¸­å®šä¹‰çš„å®é™…ç±»å‹
// æ‰€æœ‰å…¬å…±ç±»å‹ã€å¸¸é‡å’Œå‡½æ•°å·²åœ¨ç›¸åº”çš„æºæ–‡ä»¶ä¸­å®šä¹‰ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤å¯¼å‡º
// ç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨ wwplugin.PluginHostã€wwplugin.NewPlugin() ç­‰
```

### 7. ä»£ç å†…è”æ³¨é‡Š

#### å…³é”®é€»è¾‘æ³¨é‡Š
```go
func (ph *PluginHost) startGrpcServer() error {
    startPort := ph.config.PortRange[0]
    maxPort := ph.config.PortRange[1]

    // å¦‚æœæŒ‡å®šäº†å…·ä½“ç«¯å£ï¼Œåˆ™åªå°è¯•è¯¥ç«¯å£
    if ph.config.Port > 0 {
        startPort = ph.config.Port
        maxPort = ph.config.Port
    }

    // è‡ªåŠ¨å¯»æ‰¾å¯ç”¨ç«¯å£
    for port := startPort; port <= maxPort; port++ {
        address := fmt.Sprintf(":%d", port)
        listener, err = net.Listen("tcp", address)
        if err == nil {
            actualPort = port
            log.Printf("ğŸ¯ æ‰¾åˆ°å¯ç”¨ç«¯å£: %d", actualPort)
            break // æ‰¾åˆ°å¯ç”¨ç«¯å£ï¼Œé€€å‡ºå¾ªç¯
        }
        log.Printf("ç«¯å£ %d è¢«å ç”¨ï¼Œå°è¯•ä¸‹ä¸€ä¸ª...", port)
    }
}
```

## ğŸ¯ æ³¨é‡ŠåŸåˆ™

1. **å®Œæ•´æ€§**: æ¯ä¸ªå…¬å…±å‡½æ•°ã€ç»“æ„ä½“ã€æ¥å£éƒ½å¿…é¡»æœ‰æ³¨é‡Š
2. **å‡†ç¡®æ€§**: æ³¨é‡Šå†…å®¹å¿…é¡»ä¸ä»£ç å®ç°ä¿æŒä¸€è‡´
3. **æ¸…æ™°æ€§**: ä½¿ç”¨ç®€æ´æ˜äº†çš„ä¸­æ–‡æè¿°åŠŸèƒ½å’Œç”¨é€”
4. **å±‚æ¬¡æ€§**: ä½¿ç”¨åˆ†ç»„æ³¨é‡Šå’Œä¸åŒçº§åˆ«çš„è¯´æ˜
5. **å®ç”¨æ€§**: åŒ…å«å‚æ•°è¯´æ˜ã€è¿”å›å€¼è¯´æ˜å’Œä½¿ç”¨ç¤ºä¾‹

## ğŸ“‹ æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰å¯¼å…¥åŒ…éƒ½æœ‰ç”¨é€”è¯´æ˜
- [ ] æ‰€æœ‰å…¬å…±ç±»å‹éƒ½æœ‰è¯¦ç»†æ³¨é‡Š
- [ ] æ‰€æœ‰å…¬å…±å‡½æ•°éƒ½æœ‰å‚æ•°å’Œè¿”å›å€¼è¯´æ˜
- [ ] æ‰€æœ‰é…ç½®å­—æ®µéƒ½æœ‰ç”¨é€”å’Œé»˜è®¤å€¼è¯´æ˜
- [ ] æ‰€æœ‰å¸¸é‡éƒ½æœ‰å«ä¹‰è¯´æ˜
- [ ] å¤æ‚é€»è¾‘éƒ½æœ‰å†…è”æ³¨é‡Šè§£é‡Š
- [ ] ç¤ºä¾‹ä»£ç åŒ…å«å®Œæ•´çš„ä½¿ç”¨è¯´æ˜

è¿™äº›æ³¨é‡Šè§„èŒƒç¡®ä¿äº†ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œæ–¹ä¾¿å…¶ä»–å¼€å‘è€…ç†è§£å’Œä½¿ç”¨WWPluginæ¡†æ¶ã€‚